{% extends 'base.html' %}
{% block title %}Config Builder | SonicWall{% endblock %}
{% block content %}
<div class="mx-auto mt-5" style="max-width: 900px;">
    <div class="card p-4 mb-4">
        <h4 class="mb-3 text-center">Visual Configuration Builder</h4>
        <form class="mb-3" method="GET" action="">
            <div class="row align-items-end">
                <div class="col-md-8">
                    <label class="form-label">Open Existing Template</label>
                    <select class="form-select" name="template_picker" id="template_picker" onchange="if(this.value) window.location.href='/edit_template/' + this.value;">
                        <option value="">-- Select a template to edit --</option>
                        {% for t in templates %}
                            <option value="{{ t }}" {% if t == template_name %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
        <form method="POST" action="{{ url_for('save_template') }}">
            <div class="mb-3">
                <label class="form-label">Template Name</label>
                <input type="text" class="form-control" name="template_name" required value="{{ template_name }}">
            </div>
            <h5 class="mt-4">Administration</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Firewall Name</label>
                    <input type="text" class="form-control" name="firewall_name" value="{{ admin.firewall_name }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">HTTP Port</label>
                    <input type="number" class="form-control" name="http_port" value="{{ admin.http_port }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">HTTPS Port</label>
                    <input type="number" class="form-control" name="https_port" value="{{ admin.https_port }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Idle Logout Time</label>
                    <input type="number" class="form-control" name="idle_logout_time" value="{{ admin.idle_logout_time }}">
                </div>
            </div>
            <h5 class="mt-4">Zones</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6>LAN</h6>
                    {% for key, value in zones.LAN.items() %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="lan_{{ key }}" id="lan_{{ key }}" {% if value %}checked{% endif %}>
                            <label class="form-check-label" for="lan_{{ key }}">{{ key.replace('_', ' ').title() }}</label>
                        </div>
                    {% endfor %}
                </div>
                <div class="col-md-6">
                    <h6>WAN</h6>
                    {% for key, value in zones.WAN.items() %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="wan_{{ key }}" id="wan_{{ key }}" {% if value %}checked{% endif %}>
                            <label class="form-check-label" for="wan_{{ key }}">{{ key.replace('_', ' ').title() }}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <h5 class="mt-4">Interfaces</h5>
            <div id="interfaces-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addInterface()">Add Interface</button>
            <h5 class="mt-4">Address Objects</h5>
            <div id="address-objects-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addAddressObject()">Add Address Object</button>
            <h5 class="mt-4">Address Groups</h5>
            <div id="address-groups-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addAddressGroup()">Add Address Group</button>
            <h5 class="mt-4">Service Objects</h5>
            <div id="service-objects-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addServiceObject()">Add Service Object</button>
            <h5 class="mt-4">Service Groups</h5>
            <div id="service-groups-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addServiceGroup()">Add Service Group</button>
            <h5 class="mt-4">Access Rules</h5>
            <div id="access-rules-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addAccessRule()">Add Access Rule</button>
            <h5 class="mt-4">DHCP Server</h5>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Enable DHCP Server</label>
                    <input type="checkbox" class="form-check-input" name="dhcp_enabled">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Conflict Detection</label>
                    <input type="checkbox" class="form-check-input" name="dhcp_conflict_detection">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Persistence (JSON)</label>
                    <input type="text" class="form-control" name="dhcp_persistence" placeholder='{"key": "value"}'>
                </div>
            </div>
            <div id="dhcp-options-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addDhcpOption()">Add DHCP Option</button>
            <h5 class="mt-4">Anti-Spam</h5>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="anti_spam_enabled" id="anti_spam_enabled">
                <label class="form-check-label" for="anti_spam_enabled">Enable Anti-Spam</label>
            </div>
            <h5 class="mt-4">Realtime Blacklisting</h5>
            <div class="row">
                <div class="col-md-2 mb-3">
                    <label class="form-label">Enable RBL</label>
                    <input type="checkbox" class="form-check-input" name="rbl_enabled">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">DNS</label>
                    <input type="text" class="form-control" name="rbl_dns">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Domain</label>
                    <input type="text" class="form-control" name="rbl_domain">
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Service Enable</label>
                    <input type="checkbox" class="form-check-input" name="rbl_service_enable">
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Block All</label>
                    <input type="checkbox" class="form-check-input" name="rbl_block_all">
                </div>
            </div>
            <h5 class="mt-4">SSL VPN Server</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">SSL VPN Port</label>
                    <input type="number" class="form-control" name="sslvpn_port">
                </div>
            </div>
            <h5 class="mt-4">SSL Control</h5>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="ssl_control_enabled" id="ssl_control_enabled">
                <label class="form-check-label" for="ssl_control_enabled">Enable SSL Control</label>
            </div>
            <h5 class="mt-4">Time</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Use NTP</label>
                    <input type="checkbox" class="form-check-input" name="time_use_ntp">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Time Zone</label>
                    <input type="text" class="form-control" name="time_zone">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Daylight Savings</label>
                    <input type="checkbox" class="form-check-input" name="time_daylight_savings">
                </div>
            </div>
            <h5 class="mt-4">Firewall</h5>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="firewall_stealth_mode" id="firewall_stealth_mode">
                <label class="form-check-label" for="firewall_stealth_mode">Stealth Mode</label>
            </div>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="firewall_randomize_id" id="firewall_randomize_id">
                <label class="form-check-label" for="firewall_randomize_id">Randomize ID</label>
            </div>
            <h5 class="mt-4">Security Services</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Security Level</label>
                    <select class="form-select" name="security_services_level">
                        <option value="maximum">Maximum</option>
                        <option value="medium">Medium</option>
                        <option value="minimum">Minimum</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Reduce ISDN Antivirus Traffic</label>
                    <input type="checkbox" class="form-check-input" name="security_services_reduce_isdn">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Drop Packets at Reload</label>
                    <input type="checkbox" class="form-check-input" name="security_services_drop_packets">
                </div>
            </div>
            <h5 class="mt-4">VoIP</h5>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="voip_consistent_nat" id="voip_consistent_nat">
                <label class="form-check-label" for="voip_consistent_nat">Consistent NAT</label>
            </div>
            <h5 class="mt-4">Anti-Spyware</h5>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="anti_spyware_enabled" id="anti_spyware_enabled">
                <label class="form-check-label" for="anti_spyware_enabled">Enable Anti-Spyware</label>
            </div>
            <h5 class="mt-4">Failover Load Balancing</h5>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" name="failover_lb_enabled" id="failover_lb_enabled">
                <label class="form-check-label" for="failover_lb_enabled">Enable Failover Load Balancing</label>
            </div>
            <div class="mt-4 text-end">
                <button type="submit" class="btn btn-success">Save Template</button>
            </div>
        </form>
    </div>
</div>
<script>
let addrObjCount = 0;
function addAddressObject() {
    const container = document.getElementById('address-objects-list');
    const idx = addrObjCount++;
    const html = `
    <div class="card mb-2 p-3" id="addr-obj-${idx}">
        <div class="row g-2">
            <div class="col-12 col-md-3 mb-2">
                <input type="text" class="form-control" name="addr_name_${idx}" placeholder="Name" required>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <select class="form-select" name="addr_type_${idx}">
                    <option value="host">Host</option>
                    <option value="range">Range</option>
                    <option value="network">Network</option>
                </select>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="addr_zone_${idx}" placeholder="Zone" required>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="addr_ip_${idx}" placeholder="Host IP">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="addr_range_begin_${idx}" placeholder="Range Begin">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="addr_range_end_${idx}" placeholder="Range End">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="addr_subnet_${idx}" placeholder="Subnet">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="addr_mask_${idx}" placeholder="Mask">
            </div>
            <div class="col-12 col-md-1 mb-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeAddressObject(${idx})">&times;</button>
            </div>
        </div>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}
function removeAddressObject(idx) {
    const el = document.getElementById(`addr-obj-${idx}`);
    if (el) el.remove();
}
let ifaceCount = 0;
function addInterface() {
    const container = document.getElementById('interfaces-list');
    const idx = ifaceCount++;
    const html = `
    <div class="card mb-2 p-3" id="iface-${idx}">
        <div class="row g-2">
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="iface_name_${idx}" placeholder="Name" required>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="iface_zone_${idx}" placeholder="Zone" required>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <select class="form-select" name="iface_ip_assignment_mode_${idx}">
                    <option value="static">Static</option>
                    <option value="dhcp">DHCP</option>
                </select>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="iface_ip_${idx}" placeholder="IP (static)">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="iface_netmask_${idx}" placeholder="Netmask (static)">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="iface_gateway_${idx}" placeholder="Gateway (static)">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="iface_dhcp_hostname_${idx}" placeholder="DHCP Hostname">
            </div>
            <div class="col-12 col-md-1 mb-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInterface(${idx})">&times;</button>
            </div>
        </div>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}
function removeInterface(idx) {
    const el = document.getElementById(`iface-${idx}`);
    if (el) el.remove();
}
// Address Groups
let addrGroupCount = 0;
function addAddressGroup() {
    const container = document.getElementById('address-groups-list');
    const idx = addrGroupCount++;
    const html = `
    <div class="card mb-2 p-3" id="addr-group-${idx}">
        <div class="row g-2">
            <div class="col-12 col-md-4 mb-2">
                <input type="text" class="form-control" name="addr_group_name_${idx}" placeholder="Group Name" required>
            </div>
            <div class="col-12 col-md-4 mb-2">
                <input type="text" class="form-control" name="addr_group_objects_${idx}" placeholder="Object Names (comma separated)">
            </div>
            <div class="col-12 col-md-3 mb-2">
                <input type="text" class="form-control" name="addr_group_groups_${idx}" placeholder="Group Names (comma separated)">
            </div>
            <div class="col-12 col-md-1 mb-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeAddressGroup(${idx})">&times;</button>
            </div>
        </div>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}
function removeAddressGroup(idx) {
    const el = document.getElementById(`addr-group-${idx}`);
    if (el) el.remove();
}
// Service Objects
let serviceObjCount = 0;
function addServiceObject() {
    const container = document.getElementById('service-objects-list');
    const idx = serviceObjCount++;
    const html = `
    <div class="card mb-2 p-3" id="service-obj-${idx}">
        <div class="row g-2">
            <div class="col-12 col-md-3 mb-2">
                <input type="text" class="form-control" name="service_obj_name_${idx}" placeholder="Name" required>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <select class="form-select" name="service_obj_type_${idx}">
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                </select>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="number" class="form-control" name="service_obj_begin_${idx}" placeholder="Port Begin">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="number" class="form-control" name="service_obj_end_${idx}" placeholder="Port End">
            </div>
            <div class="col-12 col-md-1 mb-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeServiceObject(${idx})">&times;</button>
            </div>
        </div>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}
function removeServiceObject(idx) {
    const el = document.getElementById(`service-obj-${idx}`);
    if (el) el.remove();
}
// Service Groups
let serviceGroupCount = 0;
function addServiceGroup() {
    const container = document.getElementById('service-groups-list');
    const idx = serviceGroupCount++;
    const html = `
    <div class="card mb-2 p-3" id="service-group-${idx}">
        <div class="row g-2">
            <div class="col-12 col-md-4 mb-2">
                <input type="text" class="form-control" name="service_group_name_${idx}" placeholder="Group Name" required>
            </div>
            <div class="col-12 col-md-6 mb-2">
                <input type="text" class="form-control" name="service_group_objects_${idx}" placeholder="Service Object Names (comma separated)">
            </div>
            <div class="col-12 col-md-1 mb-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeServiceGroup(${idx})">&times;</button>
            </div>
        </div>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}
function removeServiceGroup(idx) {
    const el = document.getElementById(`service-group-${idx}`);
    if (el) el.remove();
}
// Access Rules
let accessRuleCount = 0;
function addAccessRule() {
    const container = document.getElementById('access-rules-list');
    const idx = accessRuleCount++;
    const html = `
    <div class="card mb-2 p-3" id="access-rule-${idx}">
        <div class="row g-2">
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="access_rule_name_${idx}" placeholder="Rule Name" required>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="access_rule_from_zone_${idx}" placeholder="From Zone">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="access_rule_to_zone_${idx}" placeholder="To Zone">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <select class="form-select" name="access_rule_action_${idx}">
                    <option value="allow">Allow</option>
                    <option value="deny">Deny</option>
                </select>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="access_rule_source_address_${idx}" placeholder="Source Address">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="text" class="form-control" name="access_rule_destination_${idx}" placeholder="Destination">
            </div>
            <div class="col-12 col-md-1 mb-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeAccessRule(${idx})">&times;</button>
            </div>
        </div>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}
function removeAccessRule(idx) {
    const el = document.getElementById(`access-rule-${idx}`);
    if (el) el.remove();
}
// DHCP Options
let dhcpOptionCount = 0;
function addDhcpOption() {
    const container = document.getElementById('dhcp-options-list');
    const idx = dhcpOptionCount++;
    const html = `
    <div class="card mb-2 p-3" id="dhcp-option-${idx}">
        <div class="row g-2">
            <div class="col-12 col-md-3 mb-2">
                <input type="text" class="form-control" name="dhcp_option_name_${idx}" placeholder="Option Name" required>
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="number" class="form-control" name="dhcp_option_number_${idx}" placeholder="Number">
            </div>
            <div class="col-12 col-md-2 mb-2">
                <input type="checkbox" class="form-check-input" name="dhcp_option_isarray_${idx}"> Array
            </div>
            <div class="col-12 col-md-3 mb-2">
                <input type="text" class="form-control" name="dhcp_option_value_${idx}" placeholder="Value">
            </div>
            <div class="col-12 col-md-1 mb-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeDhcpOption(${idx})">&times;</button>
            </div>
        </div>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}
function removeDhcpOption(idx) {
    const el = document.getElementById(`dhcp-option-${idx}`);
    if (el) el.remove();
}
</script>
<script>
// Pre-populate Address Objects if editing a template
window.addEventListener('DOMContentLoaded', function() {
    var addrObjs = {{ (template_data.address_objects or [])|tojson|safe }};
    if (Array.isArray(addrObjs)) {
        addrObjs.forEach(function(obj) {
            var container = document.getElementById('address-objects-list');
            var idx = typeof addrObjCount !== 'undefined' ? addrObjCount++ : 0;
            var html = `
            <div class="card mb-2 p-3" id="addr-obj-${idx}">
                <div class="row g-2">
                    <div class="col-12 col-md-3 mb-2">
                        <input type="text" class="form-control" name="addr_name_${idx}" placeholder="Name" required value="${obj.name || ''}">
                    </div>
                    <div class="col-12 col-md-2 mb-2">
                        <select class="form-select" name="addr_type_${idx}">
                            <option value="host" ${obj.type === 'host' ? 'selected' : ''}>Host</option>
                            <option value="range" ${obj.type === 'range' ? 'selected' : ''}>Range</option>
                            <option value="network" ${obj.type === 'network' ? 'selected' : ''}>Network</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2 mb-2">
                        <input type="text" class="form-control" name="addr_zone_${idx}" placeholder="Zone" required value="${obj.zone || ''}">
                    </div>
                    <div class="col-12 col-md-2 mb-2">
                        <input type="text" class="form-control" name="addr_ip_${idx}" placeholder="Host IP" value="${obj.host_ip || ''}">
                    </div>
                    <div class="col-12 col-md-2 mb-2">
                        <input type="text" class="form-control" name="addr_range_begin_${idx}" placeholder="Range Begin" value="${obj.range_begin || ''}">
                    </div>
                    <div class="col-12 col-md-2 mb-2">
                        <input type="text" class="form-control" name="addr_range_end_${idx}" placeholder="Range End" value="${obj.range_end || ''}">
                    </div>
                    <div class="col-12 col-md-2 mb-2">
                        <input type="text" class="form-control" name="addr_subnet_${idx}" placeholder="Subnet" value="${obj.subnet || ''}">
                    </div>
                    <div class="col-12 col-md-2 mb-2">
                        <input type="text" class="form-control" name="addr_mask_${idx}" placeholder="Mask" value="${obj.mask || ''}">
                    </div>
                    <div class="col-12 col-md-1 mb-2 d-flex align-items-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeAddressObject(${idx})">&times;</button>
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }
});
</script>
{% endblock %} 